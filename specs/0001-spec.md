# Agent Core 需求和设计

## 概述

`agent-core` 是一个 Rust 库，用于将 Codex 智能代理功能嵌入到其他应用程序中。该库提供了高层次 API，让开发者能够轻松创建和管理由 LLM（比如 OpenAI gpt-5）驱动的 AI 代理，并支持工具执行能力。该库是基于：

```toml
codex-common = { git = "https://github.com/openai/codex", tag = "rust-v0.23.0" }
codex-core = { git = "https://github.com/openai/codex", tag = "rust-v0.23.0" }
codex-login = { git = "https://github.com/openai/codex", tag = "rust-v0.23.0" }
codex-protocol = { git = "https://github.com/openai/codex", tag = "rust-v0.23.0" }
mcp-types = { git = "https://github.com/openai/codex", tag = "rust-v0.23.0" }
```

等 crates 构建的。请参阅 ./codex/codex-rs 下面的代码，深入了解它们的使用。请暴露内部的功能 codex-rs 内部的功能：

- Tools：用户可以很轻松配置和使用 codex-rs 内部已经建立好的 tools。
- MCP：用户可以很轻松使用 codex-rs MCP 服务器相关的功能来配置其自己的 MCP 服务器。
- Plan：codex-rs 生成的 plan 可以通过 plan mpsc 暴露给用户。
- Output：codex-rs 生成的 output 可以通过 output mpsc 暴露给用户。
- Input：用户的输入可以通过 input mpsc 提交给 codex-rs。

## 核心架构

以下内容是我的大概想法，请根据 codex-rs 的代码，以及以上需求，设计最合适的架构，接口，以及实现。

### 配置系统

```rust
let config = AgentConfig::builder()
    .model("gpt-5-mini")                           // 模型选择
    .api_key(环境变量或直接提供)                    // API 密钥
    .system_prompt("系统提示词")                    // 系统指令
    .sandbox_policy(SandboxPolicy::WorkspaceWrite) // 沙箱策略
    .approval_policy(ApprovalPolicy::Never)        // 审批策略
    .max_turns(100)                                // 最大对话轮次
    .build();
```

### 消息类型

```rust
// 输入消息
struct InputMessage {
    message: String,
    images: Vec<ImageInput>,  // 支持图片输入
}

// 输出消息
struct OutputMessage {
    turn_id: u64,
    data: OutputData,
}

// 输出数据类型
enum OutputData {
    Start,                                    // 对话开始
    Primary(String),                          // 主要响应
    PrimaryDelta(String),                     // 流式响应片段
    ToolStart { tool_name, arguments },      // 工具执行开始
    ToolComplete { tool_name, result },      // 工具执行完成
    ToolOutput { tool_name, output },        // 工具输出流
    Reasoning(String),                        // 推理过程
    TodoUpdate { todos },                     // 任务列表更新
    Completed,                                // 轮次完成
    Error(OutputError),                       // 错误
}
```

### 计划管理系统

```rust
// 内部使用专用计划通道，支持 codex 的 plan 的追踪
let (plan_tx, plan_rx) = mpsc::channel::<PlanMessage>(100);

struct PlanMessage {
    todos: Vec<TodoItem>,         // 任务列表
    metadata: Option<PlanMetadata>, // 元数据
}

struct TodoItem {
    content: String,              // 任务内容
    status: TodoStatus,           // 任务状态
}

enum TodoStatus {
    Pending,      // 待处理
    InProgress,   // 进行中
    Completed,    // 已完成
    Blocked,      // 已阻塞
}
```

## 核心功能

### 1. 代理控制

```rust
// 执行控制
let handle = agent.execute(input_rx, plan_tx, output_tx).await?;
let controller = handle.controller();

// 状态管理
controller.pause().await;   // 暂停
controller.resume().await;  // 恢复
controller.stop().await;    // 停止

// 状态查询
let state = controller.state().await;  // 获取当前状态
let turns = controller.turn_count();   // 获取轮次计数
```

### 2. 工具支持

```rust
enum ToolConfig {
    Bash { allow_network: bool },    // Shell 命令执行
    WebSearch,                        // 网络搜索
    FileRead,                         // 文件读取
    FileWrite,                        // 文件写入
    ApplyPatch,                       // 应用补丁
    Custom {                          // 自定义工具
        name: String,
        description: String,
        parameters: Value,
        handler: CustomToolHandler,
    },
}
```

### 3. MCP 服务器集成

```rust
let mcp_config = McpServerConfig::builder()
    .name("server_name")
    .command("command_to_run")
    .args(vec!["arg1", "arg2"])
    .env(HashMap::from([("KEY", "VALUE")]))
    .build();

// or 使用 http
let mcp_config = McpServerConfig::builder()
    .name("server_name")
    .url("http://localhost:8080")
    .build();
```

## 高级特性

### 1. 会话管理（可选功能）

```rust
#[cfg(feature = "session")]
use agent_core::session::SessionManager;

// 跨会话状态持久化
let session = SessionManager::new();
session.save_state(&agent).await?;
let restored_agent = session.restore_state().await?;
```

### 2. 实用工具（可选功能）

```rust
#[cfg(feature = "utils")]
use agent_core::processing;

// 文本处理和格式化
let cleaned = processing::clean_output(raw_output);
let formatted = processing::format_code(code_string);
```

## 使用示例

### 基础示例：简单对话

```rust
let config = AgentConfig::builder()
    .model("gpt-5-mini")
    .build();

let mut agent = Agent::new(config)?;
let response = agent.query("解释量子计算").await?;
println!("{}", response);
```

### 进阶示例：任务执行与追踪

```rust
let (input_tx, input_rx) = mpsc::channel(100);
let (plan_tx, mut plan_rx) = mpsc::channel(100);
let (output_tx, mut output_rx) = mpsc::channel(100);

// 启动代理
let handle = agent.execute(input_rx, plan_tx, output_tx).await?;

// 监听计划更新
tokio::spawn(async move {
    while let Some(plan) = plan_rx.recv().await {
        for todo in plan.todos {
            println!("[{}] {}", todo.status, todo.content);
        }
    }
});

// 监听输出
tokio::spawn(async move {
    while let Some(output) = output_rx.recv().await {
        println!("{}", output);
    }
});

// 等待初始任务完成
handle.await?;

// 发送任务
input_tx.send("创建一个 Python 项目并运行测试".into()).await?;
```
